import asyncio
import os
import logging
import sys
from collections import Counter

from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile
from aiogram.client.default import DefaultBotProperties

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---

logging.basicConfig(level=logging.INFO, stream=sys.stdout)

API_TOKEN = os.getenv("TELEGRAM_API_TOKEN")

if not API_TOKEN:
    sys.exit("Error: Environment variable TELEGRAM_API_TOKEN is not set.")

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ (–∏—â–µ—Ç –ø–∞–ø–∫—É piknik —Ä—è–¥–æ–º —Å —Ñ–∞–π–ª–æ–º —Å–∫—Ä–∏–ø—Ç–∞)
IMG_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "piknik")

bot = Bot(token=API_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher(storage=MemoryStorage())

# --- –î–ê–ù–ù–´–ï –¢–ï–°–¢–ê ---

QUESTIONS = [
    {
        "text": "<b>–í—ã –ø—Ä–∏—à–ª–∏ –Ω–∞ –º–µ—Å—Ç–æ —Å—Ç–æ—è–Ω–∫–∏. –° —á–µ–≥–æ –Ω–∞—á–Ω—ë—Ç–µ?</b>",
        "options": [
            "1 ‚Äî –ü—Ä–µ–¥–ª–æ–∂—É —Ä–µ—à–∏—Ç—å, –∫—Ç–æ —á–µ–º –∑–∞–π–º—ë—Ç—Å—è.",
            "2 ‚Äî –í–æ–∑—å–º—É –Ω–∞ —Å–µ–±—è —Å–∞–º—É—é —Ç—è–∂—ë–ª—É—é —Ä–∞–±–æ—Ç—É.",
            "3 ‚Äî –ó–∞—Ç–µ—é –≤–µ—Å—ë–ª—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–ª–∏ –ø–æ–¥—à—É—á—É.",
            "4 ‚Äî –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å—è–¥—É –æ—Ç–¥–æ—Ö–Ω—É—Ç—å."
        ]
    },
    {
        "text": "<b>–í–æ–∫—Ä—É–≥ —Å—Ç–æ—è–Ω–∫–∏ –≤–∞–ª—è–µ—Ç—Å—è –∫–∞–∫–æ–π-—Ç–æ –º—É—Å–æ—Ä. –í–∞—à–∞ –ø–µ—Ä–≤–∞—è –º—ã—Å–ª—å?</b>",
        "options": [
            "1 ‚Äî ¬´–î–∞–≤–∞–π—Ç–µ –ø–æ-–±—ã—Å—Ç—Ä–æ–º—É –≤—Å—ë –ø—Ä–∏–±–µ—Ä—ë–º –≤–º–µ—Å—Ç–µ¬ª.",
            "2 ‚Äî –°–ø–æ–∫–æ–π–Ω–æ —Å–æ–±–µ—Ä—É –≤—Å—ë —Å–∞–º–∞.",
            "3 ‚Äî –ü—Ä–µ–≤—Ä–∞—â—É —É–±–æ—Ä–∫—É –≤ –∏–≥—Ä—É.",
            "4 ‚Äî –ù–µ –±—É–¥—É –∑–∞–æ—Å—Ç—Ä—è—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ."
        ]
    },
    {
        "text": "<b>–ß–æ–Ω–≥—É–∫ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∑–∞ –¥—Ä–æ–≤–∞–º–∏ –æ–¥–∏–Ω, –∞ –≤ –ª–µ—Å—É —É–∂–µ —Ç–µ–º–Ω–µ–µ—Ç. –ß—Ç–æ —Å–¥–µ–ª–∞–µ—Ç–µ?</b>",
        "options": [
            "1 ‚Äî –ü–æ–ø—Ä–æ—à—É –µ—â—ë –ø–∞—Ä—É —á–µ–ª–æ–≤–µ–∫ –ø–æ–π—Ç–∏ —Å –Ω–∏–º.",
            "2 ‚Äî –ù–∞–≥–æ–Ω—é –µ–≥–æ –∏ –ø–æ–π–¥—É —Ä—è–¥–æ–º.",
            "3 ‚Äî –ü–æ–∑–æ–≤—É —Å —Å–æ–±–æ–π –•–æ—Å–æ–∫–∞, –±—É–¥–µ–º –¥—É—Ä–∞—á–∏—Ç—å—Å—è.",
            "4 ‚Äî –û—Å—Ç–∞–≤–ª—é –µ–≥–æ –æ–¥–Ω–æ–≥–æ ‚Äî –µ–º—É —ç—Ç–æ –Ω—É–∂–Ω–æ."
        ]
    },
    {
        "text": "<b>–¢—ç—Ö—ë–Ω –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä—É–Ω—ã –≥–∏—Ç–∞—Ä—ã –∏ –≤—ã–≥–ª—è–¥–∏—Ç –∑–∞–¥—É–º—á–∏–≤—ã–º. –í–∞—à–∞ —Ä–µ–∞–∫—Ü–∏—è?</b>",
        "options": [
            "1 ‚Äî –ü–æ–π–¥—É –≥—Ä–µ—Ç—å —á–∞–π –¥–ª—è –≤—Å–µ—Ö.",
            "2 ‚Äî –¢–∏—Ö–æ —Å—è–¥—É —Ä—è–¥–æ–º –≤—ã—Å–ª—É—à–∞—Ç—å.",
            "3 ‚Äî –ü–æ–¥—Ö–≤–∞—á—É –º–µ–ª–æ–¥–∏—é –∏ –ø—Ä–µ–¥–ª–æ–∂—É —Å–ø–µ—Ç—å.",
            "4 ‚Äî –ë—É–¥—É –Ω–∞–±–ª—é–¥–∞—Ç—å —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã."
        ]
    },
    {
        "text": "<b>–ß–∏–º–∏–Ω —Å–ª—É—á–∞–π–Ω–æ –ø—Ä–æ–ª–∏–≤–∞–µ—Ç –Ω–∞ —Å–µ–±—è –≥–æ—Ä—è—á–∏–π —á–∞–π. –ö–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç–µ?</b>",
        "options": [
            "1 ‚Äî –ü–æ–º–æ–≥—É —Å–Ω—è—Ç—å –º–æ–∫—Ä—É—é –æ–¥–µ–∂–¥—É.",
            "2 ‚Äî –ù–∞–π–¥—É —Å—É—Ö—É—é —Å–º–µ–Ω–∫—É –∏–ª–∏ –ø–ª–µ–¥.",
            "3 ‚Äî –ü–µ—Ä–µ–≤–µ–¥—É –≤—Å—ë –≤ —à—É—Ç–∫—É.",
            "4 ‚Äî –ü–æ–¥–æ–∂–¥—É –≤ —Å—Ç–æ—Ä–æ–Ω–µ."
        ]
    },
    {
        "text": "<b>–ù–∞–º–¥–∂—É–Ω –∏ –•–æ—Å–æ–∫ –æ —á—ë–º-—Ç–æ —Å–ø–æ—Ä—è—Ç. –ß—Ç–æ —Å–¥–µ–ª–∞–µ—Ç–µ?</b>",
        "options": [
            "1 ‚Äî –ú—è–≥–∫–æ –≤–º–µ—à–∞—é—Å—å –∏ –ø—Ä–µ–¥–ª–æ–∂—É –æ–±—Å—É–¥–∏—Ç—å –ø–æ –¥–µ–ª—É.",
            "2 ‚Äî –ü–æ–¥–æ–π–¥—É —Å–≥–ª–∞–¥–∏—Ç—å –æ—Å—Ç—Ä—ã–π –º–æ–º–µ–Ω—Ç.",
            "3 ‚Äî –í–±—Ä–æ—à—É –Ω–µ–ª–µ–ø—É—é —à—É—Ç–∫—É.",
            "4 ‚Äî –ù–µ –±—É–¥—É –º–µ—à–∞—Ç—å."
        ]
    },
    {
        "text": "<b>–£—Ç—Ä–æ, –Æ–Ω–≥–∏ –Ω–∏–∫–∞–∫ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è. –ö–∞–∫ —Å–µ–±—è –ø–æ–≤–µ–¥—ë—Ç–µ?</b>",
        "options": [
            "1 ‚Äî –ù–∞–ø–æ–º–Ω—é –ø—Ä–æ –≥—Ä–∞—Ñ–∏–∫ –∏ —Å–±–æ—Ä—ã.",
            "2 ‚Äî –ü–æ-—Ç–∏—Ö–æ–º—É –ø–æ–º–æ–≥—É –µ–º—É —Å–æ–±—Ä–∞—Ç—å—Å—è.",
            "3 ‚Äî –ü–æ-–¥–æ–±—Ä–æ–º—É –ø–æ–¥—à—É—á—É –Ω–∞–¥ —Å–æ–Ω–Ω—ã–º –≤–∏–¥–æ–º.",
            "4 ‚Äî –ù–µ —Å—Ç–∞–Ω—É –µ–≥–æ —Ç—Ä–æ–≥–∞—Ç—å."
        ]
    },
    {
        "text": "<b>–î–∂–∏–Ω –ø–µ—Ä–µ–±–æ—Ä—â–∏–ª —Å –ø–µ—Ä—Ü–µ–º –≤ —Ä–∞–º–µ–Ω–µ –∏ —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω. –ß—Ç–æ —Å–∫–∞–∂–µ—Ç–µ?</b>",
        "options": [
            "1 ‚Äî ¬´–î–∞–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–∏–º –≤–æ–¥—ã –∏–ª–∏ —Ä–∏—Å–∞¬ª.",
            "2 ‚Äî ¬´–ì–ª–∞–≤–Ω–æ–µ, —á—Ç–æ –≥–æ—Ä—è—á–æ!¬ª (–ø–æ–º–æ–≥—É –∏—Å–ø—Ä–∞–≤–∏—Ç—å).",
            "3 ‚Äî –ë—É–¥—É –µ—Å—Ç—å, —à—É—Ç—è, —á—Ç–æ –º—ã –¥—Ä–∞–∫–æ–Ω—ã.",
            "4 ‚Äî –°–ø–æ–∫–æ–π–Ω–æ –≤—Å—ë —Å—ä–µ–º –∏ –Ω–µ –ø–æ–¥–∞–º –≤–∏–¥–∞."
        ]
    },
    {
        "text": "<b>–ü–æ—Ö–æ–¥ –ø–æ–∑–∞–¥–∏. –í—ã –≤ –¥–æ–º–∏–∫–µ. –ß–µ–º –∑–∞–π–º—ë—Ç–µ—Å—å?</b>",
        "options": [
            "1 ‚Äî –°–æ–±–µ—Ä—É –≤—Å–µ—Ö –¥–ª—è –æ–±—â–µ–≥–æ —Ñ–æ—Ç–æ.",
            "2 ‚Äî –û–±–æ–π–¥—É —Ä–µ–±—è—Ç –∏ —Å–ø—Ä–æ—à—É, –∫–∞–∫ –æ–Ω–∏.",
            "3 ‚Äî –ë—É–¥—É —Å–æ —Å–º–µ—Ö–æ–º –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å –ø—Ä–æ–≤–∞–ª—ã.",
            "4 ‚Äî –ü—Ä–æ—Å—Ç–æ –ø–æ—Ä–∞–¥—É—é—Å—å –≤ —Ç–∏—à–∏–Ω–µ."
        ]
    },
    {
        # 10-–π –≤–æ–ø—Ä–æ—Å
        "text": "<b>–ü—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –ø—Ä–æ—â–∞—Ç—å—Å—è. –†–µ–±—è—Ç–∞ –≥–æ–≤–æ—Ä—è—Ç: ¬´Ïò§Îäò ÎçïÎ∂ÑÏóê ÏßÑÏßú Ï¶êÍ±∞Ïõ†Ïñ¥Ïöî¬ª. –ß—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç–µ?</b>",
        "options": [
            "1 ‚Äî –£–ª—ã–±–Ω—É—Å—å –∏ —Å–∫–∞–∂—É: ¬´–ö–æ–º–∞–æ!¬ª.",
            "2 ‚Äî –¢–µ–ø–ª–æ –ø–æ—Å–º–æ—Ç—Ä—é –∏ –∫–∏–≤–Ω—É.",
            "3 ‚Äî –ü–æ–ø—Ä–æ—à—É –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∏ –¥–æ—Å—Ç–∞–Ω—É –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫.",
            "4 ‚Äî –ó–∞—Å–º–µ—é—Å—å –∏ –ø–æ–ø—Ä–æ—à—É –Ω–∞—É—á–∏—Ç—å —Ñ—Ä–∞–∑–µ."
        ]
    }
]

RESULTS_TEXT = {
    "–õ–∏–¥–µ—Ä": (
        "<b>üèÜ –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –õ–∏–¥–µ—Ä</b>\n\n"
        "–¢—ã —Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–∏—Ç –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É –∏ –Ω–µ –±–æ–∏—Ç—Å—è –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–ª–∞–Ω, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–º–Ω–µ–≤–∞—é—Ç—Å—è. "
        "–¢–µ–±–µ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –≤—Å—ë —à–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ö–∞–æ—Å–∞. –†—è–¥–æ–º —Å —Ç–æ–±–æ–π –≥—Ä—É–ø–ø–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è —É–≤–µ—Ä–µ–Ω–Ω–æ.\n\n"
        "ü§ù <i>–ù–∞–≤–µ—Ä–Ω—è–∫–∞ –≤—ã –±—ã –±—ã—Å—Ç—Ä–æ –Ω–∞—à–ª–∏ –æ–±—â–∏–π —è–∑—ã–∫ —Å –ù–∞–º–¥–∂—É–Ω–æ–º.</i>"
    ),
    "–ó–∞–±–æ—Ç–ª–∏–≤—ã–π": (
        "<b>ü´Ç –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ó–∞–±–æ—Ç–ª–∏–≤—ã–π</b>\n\n"
        "–¢—ã –∑–∞–º–µ—á–∞–µ—à—å —Ç–æ, —á—Ç–æ –¥—Ä—É–≥–∏–µ —É–ø—É—Å–∫–∞—é—Ç: —á—å—é-—Ç–æ —É—Å—Ç–∞–ª–æ—Å—Ç—å –∏–ª–∏ –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. "
        "–¢–≤–æ—è —Å—É–ø–µ—Ä—Å–∏–ª–∞ ‚Äî –≤ —É–º–µ–Ω–∏–∏ –≤–æ–≤—Ä–µ–º—è –ø—Ä–∏–π—Ç–∏ –Ω–∞ –ø–æ–º–æ—â—å –∏ —Å–æ–∑–¥–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. "
        "–° —Ç–æ–±–æ–π –ø—Ä–æ—Å—Ç–æ –∏ –æ—á–µ–Ω—å —Å–ø–æ–∫–æ–π–Ω–æ.\n\n"
        "ü§ù <i>–¢–≤–æ—è —á—É—Ç–∫–æ—Å—Ç—å —Ç–æ—á–Ω–æ –æ—Ç–æ–∑–≤–∞–ª–∞—Å—å –±—ã –ß–∏–º–∏–Ω—É.</i>"
    ),
    "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏": (
        "<b>üéâ –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏</b>\n\n"
        "–¢–∞–º, –≥–¥–µ —Ç—ã, –≤—Å–µ–≥–¥–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ª–µ–≥—á–µ –∏ –≤–µ—Å–µ–ª–µ–µ. –¢—ã —É–º–µ–µ—à—å –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ª—é–±—É—é –∑–∞–º–∏–Ω–∫—É –≤ –∫–ª–∞—Å—Å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é "
        "–∏ –≤–æ–≤—Ä–µ–º—è —Ä–∞–∑—Ä—è–¥–∏—Ç—å –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É —à—É—Ç–∫–æ–π. –° —Ç–æ–±–æ–π –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∑–∞–ø–æ–º–∏–Ω–∞—é—Ç—Å—è —è—Ä—á–µ.\n\n"
        "ü§ù <i>–í–∞–º –±—ã–ª–æ –±—ã –æ—Å–æ–±–µ–Ω–Ω–æ –≤–µ—Å–µ–ª–æ –≤—Ç—Ä–æ–µ–º ‚Äî —Å –ß–æ–Ω–≥—É–∫–æ–º –∏ –•–æ—Å–æ–∫–æ–º!</i>"
    ),
    "–°–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å": (
        "<b>üåø –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –°–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å</b>\n\n"
        "–¢—ã —É–º–µ–µ—à—å –ª–æ–≤–∏—Ç—å –º–æ–º–µ–Ω—Ç –∏ –Ω–µ –ª—é–±–∏—à—å –ª–∏—à–Ω–µ–π —Å—É–µ—Ç—ã. –¢–µ–±–µ –≤–∞–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –∫ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–º—É "
        "–∏ –¥–∞—Ç—å —Å–æ–±—ã—Ç–∏—è–º –∏–¥—Ç–∏ —Å–≤–æ–∏–º —á–µ—Ä–µ–¥–æ–º. –¢–≤–æ—ë —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–º –≤—ã–¥–æ—Ö–Ω—É—Ç—å.\n\n"
        "ü§ù <i>–í–∞–º –±—ã–ª–æ –±—ã –æ—á–µ–Ω—å —É—é—Ç–Ω–æ —Å –Æ–Ω–≥–∏.</i>"
    ),
    "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä": (
        "<b>üìã –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</b>\n\n"
        "–¢—ã –º–∞—Å—Ç–µ—Ä—Å–∫–∏ —Å–æ–≤–º–µ—â–∞–µ—à—å —á—ë—Ç–∫–æ—Å—Ç—å –∏ —Ç–µ–ø–ª–æ—Ç—É. –ú–æ–∂–µ—à—å –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –ø—Ä–æ—Ü–µ—Å—Å —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ "
        "–Ω–µ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Å–µ–±—è –æ–±–¥–µ–ª—ë–Ω–Ω—ã–º –≤–Ω–∏–º–∞–Ω–∏–µ–º. –†—è–¥–æ–º —Å —Ç–æ–±–æ–π –≤—Å–µ–º –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ.\n\n"
        "ü§ù <i>–ö–∞–∂–µ—Ç—Å—è, –≤—ã –±—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ–ª–∞–¥–∏–ª–∏ —Å –î–∂–∏–Ω–æ–º.</i>"
    ),
    "–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π": (
        "<b>‚ú® –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π</b>\n\n"
        "–¢—ã –Ω–µ –ª—é–±–∏—à—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ —à–∞–±–ª–æ–Ω—É –∏ –æ—Ç–ª–∏—á–Ω–æ —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–∏—Ç—É–∞—Ü–∏—é. –ú–æ–∂–µ—à—å –±—ã—Ç—å –∫–µ–º —É–≥–æ–¥–Ω–æ: "
        "—Å–µ–≥–æ–¥–Ω—è ‚Äî –≤–∑—è—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É, –∑–∞–≤—Ç—Ä–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —à—É—Ç–∫–æ–π. –¢–≤–æ—è –≥–∏–±–∫–æ—Å—Ç—å –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ –∏–¥–µ–∞–ª—å–Ω–æ –≤–ø–∏—Å–∞—Ç—å—Å—è.\n\n"
        "ü§ù <i>–° —Ç–≤–æ–∏–º —É–º–µ–Ω–∏–µ–º –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è —Ç—ã –±—ã –ª–µ–≥–∫–æ –ø–æ–ª–∞–¥–∏–ª–∞ —Å –¢—ç—Ö—ë–Ω–æ–º.</i>"
    )
}

RESULT_IMAGES = {
    "–õ–∏–¥–µ—Ä": "7.jpg",
    "–ó–∞–±–æ—Ç–ª–∏–≤—ã–π": "6.jpg",
    "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏": "5.jpg",
    "–°–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å": "4.jpg",
    "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä": "3.jpg",
    "–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π": "2.jpg"
}

LINK_RESULT_POST = "https://t.me/YOUR_CHANNEL/POST_ID"
LINK_CHANNEL = "https://t.me/KoreanMaks"

# --- FSM ---

class QuizStates(StatesGroup):
    intro = State()
    question = State()

# --- –õ–û–ì–ò–ö–ê ---

def get_keyboard(is_start=False):
    rows = []
    if is_start:
        rows.append([InlineKeyboardButton(text="üèï –ò–¥—ë–º –≤ –ø–æ—Ö–æ–¥!", callback_data="start_quiz")])
    else:
        buttons = [InlineKeyboardButton(text=str(i), callback_data=f"ans:{i}") for i in range(1, 5)]
        rows.append(buttons)
    return InlineKeyboardMarkup(inline_keyboard=rows)

def calculate_result(answers):
    # 1. –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 9 –æ—Ç–≤–µ—Ç–æ–≤
    main_answers = answers[:9]
    counts = Counter(main_answers)
    
    # –°—á–∏—Ç–∞–µ–º —á–∞—Å—Ç–æ—Ç—ã (c1..c4)
    c1 = counts.get(1, 0)
    c2 = counts.get(2, 0)
    c3 = counts.get(3, 0)
    c4 = counts.get(4, 0)
    
    # 2. –°—á–∏—Ç–∞–µ–º —Å—É–º–º—ã –≥—Ä—É–ø–ø
    g12 = c1 + c2
    g34 = c3 + c4
    
    # 3.1 –õ–æ–≥–∏–∫–∞ –≥—Ä—É–ø–ø (–ù–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ)
    if g12 > g34:
        return "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä"
    if g34 > g12:
        return "–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π"
        
    # 3.2 –õ–æ–≥–∏–∫–∞ —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ (g12 == g34) - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–≥–æ–≥–æ –ª–∏–¥–µ—Ä–∞
    max_val = max(c1, c2, c3, c4)
    
    # –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö, —É –∫–æ–≥–æ –º–∞–∫—Å–∏–º—É–º –±–∞–ª–ª–æ–≤
    candidates = []
    if c1 == max_val: candidates.append("–õ–∏–¥–µ—Ä")
    if c2 == max_val: candidates.append("–ó–∞–±–æ—Ç–ª–∏–≤—ã–π")
    if c3 == max_val: candidates.append("–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏")
    if c4 == max_val: candidates.append("–°–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å")
    
    # –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω (—Å—Ç—Ä–æ–≥–∏–π –º–∞–∫—Å–∏–º—É–º) ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    if len(candidates) == 1:
        return candidates[0]
        
    # 3.3 –ù–∏—á—å—è –≤ –º–∞–∫—Å–∏–º—É–º–µ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ –Ω–∞–±—Ä–∞–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –º–∞–∫—Å. –∫–æ–ª-–≤–æ)
    # –°–º–æ—Ç—Ä–∏–º –Ω–∞ 9-–π –æ—Ç–≤–µ—Ç (–∏–Ω–¥–µ–∫—Å 8)
    last_ans = main_answers[8]
    
    if last_ans == 1: return "–õ–∏–¥–µ—Ä"
    if last_ans == 2: return "–ó–∞–±–æ—Ç–ª–∏–≤—ã–π"
    if last_ans == 3: return "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏"
    if last_ans == 4: return "–°–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å"
    
    # –ù–∞ —Å–ª—É—á–∞–π –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (fallback)
    return "–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π"

# --- –•–ï–ù–î–õ–ï–†–´ ---

@dp.message(Command("start"))
@dp.message(F.text.lower() == "–ø—Ä–∏–≤–µ—Ç")
async def cmd_start(message: types.Message, state: FSMContext):
    await state.clear()
    
    intro_text = (
        "<b>–û–ø—Ä–µ–¥–µ–ª–∏ —Å–≤–æ–π —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–∏—Å—å –≤ –ø–æ—Ö–æ–¥ —Å BTS üå≤üî•</b>\n\n"
        "–ü—Ä–µ–¥—Å—Ç–∞–≤—å: —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è –≤ –ø–æ—Ö–æ–¥ –≤–º–µ—Å—Ç–µ —Å —Ä–µ–±—è—Ç–∞–º–∏ –∏–∑ BTS.\n"
        "–í–æ–∫—Ä—É–≥ —Ç–æ–ª—å–∫–æ –≥–æ—Ä—ã, –ª–µ—Å –∏ —Ç–∏—à–∏–Ω–∞. –í–ø–µ—Ä–µ–¥–∏ ‚Äî —É—é—Ç–Ω—ã–µ –≤–µ—á–µ—Ä–∞ —É –∫–æ—Å—Ç—Ä–∞, –ø–µ—Å–Ω–∏ –ø–æ–¥ –≥–∏—Ç–∞—Ä—É "
        "–∏ —Ç–µ —Å–∞–º—ã–µ –∏—Å–∫—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –ø–æ–¥ –∑–≤—ë–∑–¥–∞–º–∏.\n\n"
        "–ù–æ –ª—é–±–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –µ—â—ë –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç–∏. –ü—Ä–æ–π–¥–∏ —ç—Ç–æ—Ç –ø—É—Ç—å –∏–∑ 10 —Å–∏—Ç—É–∞—Ü–∏–π "
        "–∏ —É–∑–Ω–∞–π, –∫–∞–∫—É—é —Ä–æ–ª—å —Ç—ã –∏–≥—Ä–∞–µ—à—å –≤ –∫–æ–º–ø–∞–Ω–∏–∏!\n\n"
        "–ü–æ–π–¥—ë–º?"
    )
    
    photo_path = os.path.join(IMG_DIR, "1.jpg")
    print(f"–ò—â—É –∫–∞—Ä—Ç–∏–Ω–∫—É –∑–¥–µ—Å—å: {photo_path}")
    if os.path.exists(photo_path):
        await message.answer_photo(
            photo=FSInputFile(photo_path),
            caption=intro_text,
            reply_markup=get_keyboard(is_start=True)
        )
    else:
        print("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        await message.answer(intro_text, reply_markup=get_keyboard(is_start=True))
        
    await state.set_state(QuizStates.intro)

@dp.callback_query(F.data == "start_quiz")
async def start_quiz(callback: types.CallbackQuery, state: FSMContext):
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã
    await state.set_state(QuizStates.question)
    await state.update_data(current_index=0, answers=[])
    
    q_data = QUESTIONS[0]
    total_q = len(QUESTIONS)
    header = f"<b>[{1}/{total_q}]</b>\n"
    
    text = header + f"{q_data['text']}\n\n" + "\n".join(q_data['options'])
    
    # –ò–ó–ú–ï–ù–ï–ù–ò–ï:
    # –í–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è (delete), –º—ã –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    # (–±—É–¥—å —Ç–æ –ò–Ω—Ç—Ä–æ –∏–ª–∏ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—à–ª–æ–≥–æ —Ç–µ—Å—Ç–∞), —á—Ç–æ–±—ã –æ–Ω–æ –æ—Å—Ç–∞–ª–æ—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏.
    try:
        await callback.message.edit_reply_markup(reply_markup=None)
    except:
        pass
        
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ù–û–í–´–ú —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤–Ω–∏–∑ –ø–æ –ª–µ–Ω—Ç–µ
    await callback.message.answer(text, reply_markup=get_keyboard(is_start=False))
    await callback.answer()

@dp.callback_query(F.data.startswith("ans:"))
async def process_answer(callback: types.CallbackQuery, state: FSMContext):
    answer = int(callback.data.split(":")[1])
    data = await state.get_data()
    
    current_index = data.get("current_index", 0)
    answers = data.get("answers", [])
    answers.append(answer)
    
    # 1. –û–ë–ù–û–í–õ–Ø–ï–ú –¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–° (—á—Ç–æ–±—ã –æ–Ω –æ—Å—Ç–∞–ª—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å –≤—ã–±–æ—Ä–æ–º)
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    curr_q_data = QUESTIONS[current_index]
    total_q = len(QUESTIONS)
    
    # –¢–µ–∫—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–∏–Ω–¥–µ–∫—Å—ã –º–∞—Å—Å–∏–≤–∞ —Å–¥–≤–∏–Ω—É—Ç—ã –Ω–∞ -1 –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤ 1-4)
    selected_option_text = curr_q_data['options'][answer - 1]
    
    header = f"<b>[{current_index + 1}/{total_q}]</b>\n"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —ç—Ç–æ–≥–æ —à–∞–≥–∞
    history_text = (
        f"{header}{curr_q_data['text']}\n\n"
        f"‚úÖ <b>–í—ã–±—Ä–∞–Ω–æ:</b> {selected_option_text}"
    )
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ —É–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
    await callback.message.edit_text(history_text, reply_markup=None)
    
    # 2. –ü–ï–†–ï–•–û–î–ò–ú –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –í–û–ü–†–û–°–£
    
    next_index = current_index + 1
    
    if next_index < len(QUESTIONS):
        await state.update_data(current_index=next_index, answers=answers)
        
        q_data = QUESTIONS[next_index]
        
        header = f"<b>[{next_index + 1}/{total_q}]</b>\n"
        text = header + f"{q_data['text']}\n\n" + "\n".join(q_data['options'])
        
        # –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï (–≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ)
        await callback.message.answer(text, reply_markup=get_keyboard(is_start=False))
        await callback.answer()
    else:
        # --- –§–ò–ù–ê–õ ---
        # –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å —É–∂–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω –∏ –æ—Å—Ç–∞–ª—Å—è –≤–∏—Å–µ—Ç—å.
        # –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
        
        loading_text = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ–π –ø–æ—Ö–æ–¥–Ω—ã–π —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏"
        msg = await callback.message.answer(f"{loading_text} üå≤")
        
        for _ in range(2): 
            await asyncio.sleep(0.5)
            await msg.edit_text(f"{loading_text} üå≤üå≤")
            await asyncio.sleep(0.5)
            await msg.edit_text(f"{loading_text} üå≤üå≤üå≤")
            await asyncio.sleep(0.5)
            await msg.edit_text(f"{loading_text} üå≤")
            
        await msg.delete()
        
        result_type = calculate_result(answers)
        result_desc = RESULTS_TEXT.get(result_type, RESULTS_TEXT["–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π"])
        
        final_text = (
            f"{result_desc}\n\n"
            "–ê –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —á–∞—â–µ –≤–∏–¥–µ—Ç—å—Å—è —Å –ª—é–±–∏–º–∫–∞–º–∏ –∏ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ç–∞–∫–∏—Ö –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è—Ö ‚Äî "
            "–ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ –º–æ–π –∫–∞–Ω–∞–ª. –¢–∞–º —Ç–µ–±—è –∂–¥—ë—Ç –µ—â—ë –º–Ω–æ–≥–æ —Ç—ë–ø–ª—ã—Ö –∏—Å—Ç–æ—Ä–∏–π –∏ –∫–ª–∞—Å—Å–Ω—ã—Ö —à—Ç—É–∫."
        )
        
        kb_list = [
            [InlineKeyboardButton(text="üì∏ –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç", url=LINK_RESULT_POST)],
            [InlineKeyboardButton(text="‚ú® –ë–æ–ª—å—à–µ –∏—Å—Ç–æ—Ä–∏–π —Å –ª—é–±–∏–º–∫–∞–º–∏", url=LINK_CHANNEL)],
            [InlineKeyboardButton(text="üîÑ –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ", callback_data="start_quiz")]
        ]
        
        image_filename = RESULT_IMAGES.get(result_type, "7.jpg")
        photo_path = os.path.join(IMG_DIR, image_filename)
        
        if os.path.exists(photo_path):
            await callback.message.answer_photo(
                photo=FSInputFile(photo_path),
                caption=final_text,
                reply_markup=InlineKeyboardMarkup(inline_keyboard=kb_list)
            )
        else:
            await callback.message.answer(
                final_text, 
                reply_markup=InlineKeyboardMarkup(inline_keyboard=kb_list)
            )
            
        await state.clear()
        await callback.answer()

@dp.message(QuizStates.question)
async def handle_text_in_quiz(message: types.Message):
    await message.delete() 
    msg = await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫ –≤—ã—à–µ üëÜ")
    await asyncio.sleep(3)
    try:
        await msg.delete()
    except:
        pass

@dp.message()
async def handle_unknown(message: types.Message):
    await message.answer("–ù–∞–∂–º–∏ /start, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ—Ö–æ–¥ —Å BTS!")

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
